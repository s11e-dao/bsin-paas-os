# 微信分账功能使用说明

## 功能概述

微信分账功能基于[微信支付分账文档](https://pay.weixin.qq.com/doc/v3/merchant/4012067962)实现，支持商户将交易成功的资金按照一定周期分账给其他方。

## 主要功能

### 1. 平台应用管理
- 查询当前添加的平台应用
- 显示应用基本信息（名称、描述、ID、状态等）
- 支持应用搜索和分页

### 2. 支付通道配置
- 自动获取应用的微信支付通道配置
- 显示通道参数、费率、支持模式等信息
- 验证分账功能的前置条件

### 3. 微信分账API操作

#### 核心分账操作
- **请求分账**: 向微信支付平台发起分账请求
- **查询分账结果**: 查询分账请求的处理结果
- **请求分账回退**: 请求分账回退，将已分账资金退回
- **查询分账回退结果**: 查询分账回退请求的处理结果

#### 资金管理操作
- **解冻剩余资金**: 解冻订单中剩余未分账资金
- **查询剩余待分金额**: 查询订单中剩余可分账金额

#### 接收方管理
- **添加分账接收方**: 添加分账接收方信息
- **删除分账接收方**: 删除已添加的分账接收方

#### 账单管理
- **申请分账账单**: 申请分账账单文件
- **下载账单**: 下载分账账单文件

### 4. 操作历史记录
- 记录所有API操作的请求参数和响应结果
- 显示操作状态和时间
- 支持清空历史记录

## 使用流程

### 第一步：选择应用
1. 在"平台应用"标签页中查看应用列表
2. 点击"配置分账"按钮选择要配置的应用
3. 系统会自动获取该应用的微信支付通道配置

### 第二步：配置分账
1. 切换到"分账配置"标签页
2. 查看应用配置信息和支付通道配置
3. 确认支持分账功能（需要配置微信支付通道）

### 第三步：执行分账操作
1. 在"微信分账API操作"区域选择要执行的操作
2. 点击对应的操作卡片
3. 在弹出的表单中填写必要参数
4. 提交操作并查看结果

### 第四步：查看历史
1. 切换到"操作历史"标签页
2. 查看所有操作记录
3. 分析操作结果和错误信息

## 分账业务场景

### 员工奖励
零售、餐饮等行业中，当销售人员销售完成后，达到可奖励的条件，可以通过分账将销售奖励分给员工。

### 管理资金到账时间
在酒店行业中，利用分账功能中的"冻结/解冻"能力，避免用户退款时商户账户资金不足的情况。

### 分润给合作伙伴
在与他方合作的情况下，可以用"分账"功能，将交易资金分给合作伙伴，例如物流合作商。

## 技术特点

### 资金冻结机制
- 待分账资金冻结，可实时分账或延时分账
- 实现管理账期，最长30天内可分账

### 灵活分账方式
- 基于每笔订单按金额进行分账
- 可单次或多次分账，每次可以分给多方
- 一笔订单最多可以分50次，每一次可以分给50方

### 接收方类型
- 可分给微信商户账户或个人零钱
- 支持商户号和个人openid两种类型

### 安全控制
- 商户的超管须配置允许分账的最大比例
- 默认最高分账比例为30%
- 零成本，免手续费

## 注意事项

1. **前置条件**: 应用必须配置微信支付通道才能使用分账功能
2. **分账比例**: 实际分账金额必须小于订单金额 × 允许分账的最大比例
3. **时间限制**: 分账操作必须在交易完成后30天内进行
4. **接收方管理**: 添加分账接收方后才能进行分账操作
5. **错误处理**: 所有操作都有相应的错误处理和状态反馈

## API接口说明

所有分账操作都通过后端API接口实现，前端负责参数收集和结果展示。具体接口包括：

- `/wx/profitShare/request` - 请求分账
- `/wx/profitShare/query` - 查询分账结果
- `/wx/profitShare/return` - 请求分账回退
- `/wx/profitShare/returnQuery` - 查询分账回退结果
- `/wx/profitShare/unfreeze` - 解冻剩余资金
- `/wx/profitShare/remaining` - 查询剩余待分金额
- `/wx/profitShare/addReceiver` - 添加分账接收方
- `/wx/profitShare/deleteReceiver` - 删除分账接收方
- `/wx/profitShare/applyBill` - 申请分账账单
- `/wx/profitShare/downloadBill` - 下载账单 